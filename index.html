<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
        <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <title>Hello, world!</title>
</head>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<canvas id="canvas"></canvas>

<script>

var g_globalState = {
    canvasClickLocation: {x: 50, y: 50},

};

var g_p;
var imgw = 100;
var imgh = 100;
var imgsrc = "image8-2.webp";
var g_img = new Image();
g_img.src = imgsrc;




function getCurrentPageMousePosition(e) {
    return {
        x: e.pageX,
        y: e.pageY
    };
}


function getCurrentCanvasMousePosition(e, canvasElem) {
    if (e.originalEvent.changedTouches != null && canvasElem != null) {
        var rect = canvasElem.getBoundingClientRect();
        return {
            x: e.originalEvent.changedTouches[0].clientX - rect.left,
            y: e.originalEvent.changedTouches[0].clientY - rect.top
        };
    } else if (e.clientX || e.clientX === 0 && canvasElem != null) {
        var rect = canvasElem.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    } else {
        console.log("Error: Invalid state");
    }
}



$("#" + "canvas").mousedown(function (e) {
    e.preventDefault();

    var canvasElem = $("#" + "canvas")[0];
    const pageMousePosition = getCurrentPageMousePosition(e);
    const canvasMousePosition = getCurrentCanvasMousePosition(e, canvasElem);
    console.log(pageMousePosition);
    console.log(canvasMousePosition);

    g_globalState.canvasClickLocation = canvasMousePosition;
    draw()
});

function tomdrawlin() {
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(300, 150);
    ctx.stroke();
}


function getPixels(image, width, height) {
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    context.drawImage(image, 0, 0, width, height);
    return context.getImageData(0, 0, width, height).data;
}

function pointArrayToSpline() {

}

function toBlackAndWhite(imageData) {
    var output = []
    for (i = 0; i < imgh; i++) {
        for (j = 0; j < imgw; j++) {
            var index = ( i * (imgw * 4) ) + (j * 4)
            var val = ((imageData[index] + imageData[index+1] + imageData[index+2])/3.0)
            output.push(val)
        }
    }
    return output
}

function main() {
    //g_p = toBlackAndWhite(getPixels())
    draw();
}

function plotPoints(inputArr, yval, xval, leftVal, rightVal){
    labels = [];
    nulllist = [];
    nulllistr = [];
    nulllistl = [];

    for (i = 0; i < inputArr.length; i++)
    {
        labels.push(i);

        nulllist.push( (i != xval)? null : inputArr[xval] );
        nulllistr.push( (i != rightVal)? null : inputArr[rightVal] );
        nulllistl.push( (i != leftVal)? null : inputArr[leftVal] );
    }
    console.log(xval);
    // Initialize a Line chart in the container with the ID chart1
    new Chartist.Line('#chart1', {
        labels: labels,
        series: [ inputArr, nulllist, nulllistr, nulllistl ]
    });
}

function findRightPointOfAnchor(output, xval) {
    var deltaTotal = 0;
    for (i = xval + 1; i < output.length; i++) {
        deltaTotal += Math.abs( output[i+1] - output[i] );
        console.log("deltaTotal: " + deltaTotal);
        if (deltaTotal > 200){
            return i;
        }
    }
}

function findLeftPointOfAnchor(output, xval) {
    var deltaTotal = 0;
    for (i = 0; i < xval; i++) {
        deltaTotal += Math.abs( output[i+1] - output[i] );
        console.log("deltaTotal: " + deltaTotal);
        if (deltaTotal > 200){
            return i;
        }
    }
}

function plotImagePoints(yval, xval) {
    var output = []
    for (i = 0 ; i < imgw; i++) {
        output.push(g_p[yval*imgw + i])
    }
    rightVal = findRightPointOfAnchor(output, xval);
    leftVal = findLeftPointOfAnchor(output, xval);

    plotPoints( output, yval, xval, leftVal, rightVal )
}

function draw() {
    var d = new Date();
    var n = d.getTime();
    var delta =  Math.round(100*(( n % 30000)/30000) );
    g_p = toBlackAndWhite(getPixels(g_img, imgw + delta , imgh));
    plotImagePoints(g_globalState.canvasClickLocation.y, g_globalState.canvasClickLocation.x)
    setTimeout(draw, 0)
}

</script>
<style>
.ct-chart {
    width: 600px;
    height: 400px;


}
.ct-series-b .ct-point{
    stroke: blue !important;
}
</style>
<body>
<div class="ct-chart ct-golden-section" id="chart1" width="100"></div>


<script>

</script>

<h1>Hello, world!</h1>
<img src="image8-2.webp" width="200" height="200" onload="main()"/>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>



</body>
</html>
